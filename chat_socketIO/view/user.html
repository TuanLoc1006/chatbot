<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>User</title>
    <link rel="stylesheet" href="../css/user.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" />
    <!-- font awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- boostrap -->
<<<<<<< HEAD
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <style>
        #typing {
            position: absolute;
            bottom: 150px;
            left: 10px;
            z-index: 10000;
        }
        .mess-content {
            max-width: 300px;
        }
    </style>
</head>

<body>
    <div id="mess-content">
        <ul id="messages"></ul>
    </div>
    <div>
        <form id="form" action="">
            <input maxlength="20" id="user-name" required type="text" placeholder="Nh·∫≠p t√™n ƒë·ªÉ chat">
            <input id="input" autocomplete="off" /><button>Send</button>
            <!-- <button id="toggle-btn">Disconnect</button> -->
        </form>
    </div>
=======
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

</head>

<body>

    <div class="container">
        <button id="chat-widget-button" type="button"
            class="btn btn-primary rounded-circle chat-sign-button position-fixed"
            style="bottom: 20px; right: 20px;">üí¨</button>

        <div id="chat-widget" class="card position-fixed shadow d-none"
            style="bottom: 100px; right:20px; width: 360px; height: 500px;">
            <div class="card-header bg-primary text-white">
                <h6 id="title-chatbot">admin</h6>
                <button id="chat-widget-close-button" type="button" class="btn btn-light">X</button>
            </div>

            <div id="chat-widget-messages" class="card-body">
                <ul id="messages"></ul>
            </div>

            <div class="card-footer">
                <form id="form" action="">
                    <input maxlength="20" id="user-name" required type="text" placeholder="Nh·∫≠p t√™n ƒë·ªÉ chat"
                        class="form-control">
                    <input id="input" autocomplete="off" class="form-control" />
                    <button type="submit" class="btn btn-primary" style="margin-left: 15px; height: 30px;">Send</button>
                </form>
            </div>

            <div id="myModal" class="modal">
                <span class="close" onclick="document.getElementById('myModal').style.display='none'">&times;</span>
                <img class="modal-content" id="img01">
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function () {
            let welcomeMessageShown = false; // Variable to check if the welcome message has been displayed

            // Toggle chat widget visibility
            $("#chat-widget-button").on("click", function () {
                $("#chat-widget").toggleClass("d-none");
                if (!welcomeMessageShown) { // Check if the welcome message has not been displayed

                    welcomeMessageShown = true; // Mark the welcome message as displayed
                    scrollChatToBottom(); // Automatically scroll to the bottom
                }
                scrollChatToBottom(); // Automatically scroll to the bottom
            });

            // ƒë√≥ng khung chat
            $("#chat-widget-close-button").on("click", function () {
                $("#chat-widget").addClass("d-none");
            });

            // nh·∫•n enter g·ª≠i tin
            $("#chat-widget-input").keypress(function (event) {
                if (event.which === 13) {
                    sendMessage(); // Send message on Enter key press
                }
            });

            // g·ª≠i tin khi nh·∫•n n√∫t send
            $("#send-message-button").on("click", function () {
                sendMessage();
            });

            // Function to send a message
            // function sendMessage() {
            //     let userMessage = $("#chat-widget-input").val();
            //     $("#chat-widget-input").val(""); // Clear the input field

            //     $("#chat-widget-messages").append(`
            //         <div style='background-color: #4291e6; padding: 10px; border-radius: 12px; margin-bottom: 10px; color: white;'>
            //             <strong>B·∫°n:</strong> ${userMessage}
            //         </div>
            //     `);
            //     console.log(userMessage);

            //     $.ajax({
            //         type: "POST",
            //         url: "", // URL to the PHP handler
            //         contentType: "application/json",
            //         data: JSON.stringify({ message: userMessage }),
            //         success: function(res) {
            //             console.log(res);
            //             try {
            //                 let responses = JSON.parse(res);
            //                 responses.forEach(function(response) {
            //                     if (/\.(png|jpg|jpeg|gif)$/i.test(response)) {
            //                         var img = `<img class="myImg" style="width:100%;max-width:300px" src="${response}" alt="Image" />`;
            //                         $("#chat-widget-messages").append(`
            //                             <div><strong class='text-danger'>Bot:</strong> ${img}</div>
            //                         `);
            //                         // Click to display image modal
            //                         $("#chat-widget-messages .myImg").last().on("click", function() {
            //                             displayImageModal(this.src);
            //                         });
            //                     } else if (containsURL(response)) {
            //                         response = response.replace(/\b(http[s]?:\/\/\S+)/gi, "<a href='$1' target='_blank'>$1</a>");
            //                         $("#chat-widget-messages").append(`
            //                             <div style='background-color: #ccc; padding: 10px; border-radius: 12px; margin-bottom: 10px; color: black;'>
            //                                 <strong>CTUMP:</strong> ${response}
            //                             </div>
            //                         `);
            //                     } else {
            //                         $("#chat-widget-messages").append(`
            //                             <div style='background-color: #ccc; padding: 10px; border-radius: 12px; margin-bottom: 10px; color: black;'>
            //                                 <strong>CTUMP:</strong> ${response}
            //                             </div>
            //                         `);
            //                     }
            //                 });
            //                 scrollChatToBottom(); // Automatically scroll to the bottom
            //             } catch (e) {
            //                 console.log("Invalid JSON response from server");
            //                 displayErrorMessage("Server hi·ªán ƒëang c·∫≠p nh√¢t, li√™n h·ªá admin ƒë·ªÉ nh·∫≠n h·ªó tr·ª£ !");
            //             }
            //         },
            //         error: function(error) {
            //             console.log('Error: ', error);
            //             displayErrorMessage("ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi server: Failed to connect to localhost port 5005 after 2260 ms: Connection refused");
            //         }
            //     });
            //     scrollChatToBottom(); // Automatically scroll to the bottom
            // }

            // Function to check if a string contains a URL
            function containsURL(str) {
                var urlPattern = /\b(http[s]?:\/\/\S+)/gi;
                return urlPattern.test(str);
            }

            // Function to display an image modal
            function displayImageModal(src) {
                document.getElementById('img01').src = src;
                document.getElementById('myModal').style.display = "block";
            }

            // Function to automatically scroll to the bottom of the chat
            function scrollChatToBottom() {
                var chatMessages = document.getElementById('chat-widget-messages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Function to display error messages in the chat
            function displayErrorMessage(message) {
                $("#chat-widget-messages").append(`
                    <div style='background-color: #f8d7da; padding: 10px; border-radius: 12px; margin-bottom: 10px; color: black;'>
                        <strong>CTUMP:</strong> ${message}
                    </div>
                `);
                scrollChatToBottom(); // Automatically scroll to the bottom
            }
        });
    </script>


>>>>>>> 3f2fa0083e2a52d8345706e79cbeb5a1af7b2aa5
    <!-- ############ IMPORT SOCKET ########### -->
    <script src="/socket.io/socket.io.js"></script>
    <script>

        ////////////////SOCKET
        const socket = io();
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const messages_content = document.getElementById('messages');

        //Hi·ªÉn th·ªã tin nh·∫Øn t·ª´ db
        async function callAPIGetMessage(userid) {
            try {
                const user_admin_Mess = $.ajax({
                    type: 'GET',
                    dataType: 'json',
                    url: '/api/get_mess_user',
                    data: { userid: userid }
                });

                //console.log('CALL API TH√ÄNH C√îNG');
                return user_admin_Mess;
            } catch (err) {
                console.log(err);
                return null;
            }
        }

        //l·∫•y tin nh·∫Øn c·ªßa ng∆∞·ªùi d√πng v√† admin t·ª´ db
        document.addEventListener('DOMContentLoaded', async (e) => {
            const saveUID = localStorage.getItem('uID');
            if (saveUID) {
                //socket.emit('getUserMessages', {
                //    saveUID
                //});
                const userMessage = await callAPIGetMessage(saveUID);
                //console.log(userMessage);
                userMessage.forEach(msg => {
                    if (msg.type == 1) {
                        const item = document.createElement('li');
                        item.style.color = "red";
                        item.textContent = 'Admin: ' + msg.message;
                        messages_content.appendChild(item);
                    } else {

                        const item = document.createElement('li');
                        item.textContent = 'B·∫°n: ' + msg.message;
                        messages_content.appendChild(item);
                    }
                })
            }
        })

        //ki·ªÉm tra t√™n ng∆∞·ªùi d√πng trong localstorage
        document.addEventListener('DOMContentLoaded', (e) => {
            const saveName = localStorage.getItem('userName');
            if (saveName) {
                //hi·ªÉn th·ªã t√™n ng∆∞·ªùi d√πng
                document.getElementById('user-name').value = saveName;
            }
        })

        //h√†m t·∫°o chu·ªói ng·∫´u nhi√™n 100 byte l√†m id
        function generateRandomString(length) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-';
            let result = '';
            const charactersLength = characters.length;
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        }
        const randomString = generateRandomString(100);


        //l∆∞u t√™n ng∆∞·ªùi d√πng l√™n localstorage
        if (!localStorage.getItem('uID')) {
            localStorage.setItem('uID', randomString);
        }

        //NH·∫¨N TIN NH·∫ÆN C·ª¶A ADMIN
        socket.on(`${localStorage.getItem('uID')}`, (messages) => {
            console.log(messages)
            const item = document.createElement('li');
            item.style.color = "red"

            item.textContent = 'ADMIN: ' + messages.message;
            messages_content.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        })

        //Disconnect
        //    const toggleButton = document.getElementById('toggle-btn');
        //   toggleButton.addEventListener('click', (e) => {
        //        e.preventDefault();
        //        if (socket.connected) {
        //            toggleButton.innerText = 'Connect';
        //            socket.disconnect();
        //        } else {
        //            toggleButton.innerText = 'Disconnect';
        //            socket.connect();
        //        }
        //    });

        //g·ª≠i tin nh·∫Øn
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            //l∆∞u t√™n ng∆∞·ªùi d√πng l√™n local
            const inputName = document.getElementById('user-name').value;
            console.log(inputName);
            localStorage.setItem('userName', inputName);

            if (input.value) {
                socket.emit('client_send_to_server', {
                    uID: localStorage.getItem('uID'),
                    uName: localStorage.getItem('userName'),
                    message: input.value,
                });
                input.value = '';
            }
        });

        //nh·∫≠n tin t·ª´ server v√† hi·ªÉn th·ªã (realtime)
        //g·ª≠i ƒë·∫øn server , server emit l·∫°i tin v·ª´a g·ª≠i ƒëi ƒë·ªÉ hi·ªÉn th·ªã
        socket.on('server_send_to_client', (msg) => {
            console.log(msg);
            const item = document.createElement('li');
            item.textContent = 'B·∫°n: ' + msg;
            messages_content.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });
    </script>


</body>

</html>