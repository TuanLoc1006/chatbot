<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>User</title>
    <link rel="stylesheet" href="../css/user.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" />
    <!-- font awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- boostrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>

<body>
    <ul id="messages"></ul>
    <form id="form" action="">
        <input maxlength="20" id="user-name" required type="text" placeholder="Nhập tên để chat">
        <input id="input" autocomplete="off" /><button>Send</button>
        <!-- <button id="toggle-btn">Disconnect</button> -->
    </form>
    <!-- ############ IMPORT SOCKET ########### -->
    <script src="/socket.io/socket.io.js"></script>
    <script>

        ////////////////SOCKET
        const socket = io();
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const messages_content = document.getElementById('messages');

        //Hiển thị tin nhắn từ db
        async function callAPIGetMessage(userid){
            try {
                const user_admin_Mess = $.ajax({
                    type: 'GET',
                    dataType : 'json',
                    url :'/api/get_mess_user',
                    data: {userid: userid}
                });
                
                //console.log('CALL API THÀNH CÔNG');
                return user_admin_Mess;
            } catch(err){
                console.log(err);
                return null;
            }
        }

        //lấy tin nhắn của người dùng và admin từ db
        document.addEventListener('DOMContentLoaded',async (e) => {
            const saveUID = localStorage.getItem('uID');
            if (saveUID) {
                //socket.emit('getUserMessages', {
                //    saveUID
                //});
                const userMessage = await callAPIGetMessage(saveUID);
                //console.log(userMessage);
                userMessage.forEach(msg => {
                    if(msg.type==1){
                        const item = document.createElement('li');
                        item.style.color = "red";
                        item.textContent = 'Bạn: ' + msg.message;
                        messages_content.appendChild(item);
                    } else {
                        
                        const item = document.createElement('li');
                        item.textContent = 'Bạn: ' + msg.message;
                        messages_content.appendChild(item);
                    }
                })
            }
        })

        //kiểm tra tên người dùng trong localstorage
        document.addEventListener('DOMContentLoaded', (e) => {
            const saveName = localStorage.getItem('userName');
            if (saveName) {
                //hiển thị tên người dùng
                document.getElementById('user-name').value = saveName;
            }
        })

        //hàm tạo chuỗi ngẫu nhiên 100 byte làm id
        function generateRandomString(length) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-';
            let result = '';
            const charactersLength = characters.length;
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        }
        const randomString = generateRandomString(100);


        //lưu tên người dùng lên localstorage
        if (!localStorage.getItem('uID')) {
            localStorage.setItem('uID', randomString);
        }

        //NHẬN TIN NHẮN CỦA ADMIN
        socket.on(`${localStorage.getItem('uID')}`, (messages)=>{
            //console.log(messages)
            const item = document.createElement('li');
            item.style.color = "red"
            item.textContent = 'ADMIN: ' + messages.message;
            messages_content.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        })

        //Disconnect
        //    const toggleButton = document.getElementById('toggle-btn');
        //   toggleButton.addEventListener('click', (e) => {
        //        e.preventDefault();
        //        if (socket.connected) {
        //            toggleButton.innerText = 'Connect';
        //            socket.disconnect();
        //        } else {
        //            toggleButton.innerText = 'Disconnect';
        //            socket.connect();
        //        }
        //    });

        //gửi tin nhắn
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            //lưu tên người dùng lên local
            const inputName = document.getElementById('user-name').value;
            localStorage.setItem('userName', inputName);

            if (input.value) {
                socket.emit('client_send_to_server', {
                    uID: localStorage.getItem('uID'),
                    uName: localStorage.getItem('userName'),
                    message: input.value,
                });
                input.value = '';
            }
        });

        //nhận tin từ server và hiển thị (realtime)
        //gửi đến server , server emit lại tin vừa gửi đi để hiển thị
        socket.on('server_send_to_client', (msg) => {
            const item = document.createElement('li');
            item.textContent = 'Bạn: ' + msg;
            messages_content.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });
    </script>
</body>

</html>